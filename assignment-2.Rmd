---
output: html_document
---

```{r loadlibs, echo=FALSE,message=FALSE,error=FALSE,warning=FALSE}
library(readxl)
library(car)
library(leaps)
library(MASS)
library(TSA)
library(corrplot)
```

```{r}
hat.plot <- function(fit) { #define a function to create a hat plot
    p <- length(coefficients(fit)) #p = number of parameters estimated in the model (including the intercept)
    n <- length(fitted(fit)) #n = sample size
    plot(hatvalues(fit), #plot the hatvalues()
         main = "Index Plot of Hat Values") #title of the plot
    abline(h = c(2, 3) * p / n, #add lines at 2x and 3x times p / n
          col = "red", #line color
          lty = 2) #line type = dashed
}
```


```{r loaddata_q1}
df <- readxl::read_excel('liver.xlsx')
```

```{r}
pairs(df[,1:4])
car::scatterplotMatrix(df, #data to be plotted
                 main = "Scatter Plot Matrix")
```


```{r model_1}
model_1 <- lm(Y~BdyWt+LvrWt+Dose, data = df)
summary(model_1)
```


```{r model_1_diagonistic}
par(mfrow=c(2,2))
plot(model_1)
```


```{r model1_matrix}
mm <- model.matrix(model_1) ## same as X matrix
```

```{r 1_a}
n <- nrow(df)
nr <- ncol(df) - 1
p <- length(coef(model_1))
X <- as.matrix(cbind(rep(1, n), df$BdyWt, df$LvrWt, df$Dose))
y <- df$Y
# t(X) %*% X ## matrix multiplication in R
C <- solve(t(X) %*% X) ## solve is used for inverse of matrix, t(X) %*% X is matrix multiplication in R
C
```

```{r 1_b}
beta_hat <- solve(t(X) %*% X) %*% t(X) %*% y
coefs <- as.vector(beta_hat[,1])
y_hat <- X %*% solve(t(X) %*% X) %*% t(X) %*% y
e <- y - y_hat
sigma <- sqrt(t(e) %*% e / (n - p))
summary(model_1)$sigma
```

Equation for best fit **$\hat{Y}$: `r coefs[1]` `r ifelse(coefs[2] >= 0, '+', '-')` `r abs(coefs[2])`${X_1}$ `r ifelse(coefs[3] >= 0, '+', '-')` `r abs(coefs[3])`${X_2}$ `r ifelse(coefs[4] >= 0, '+', '-')` `r abs(coefs[4])`${X_3}$**

```{r 1_c}
anova_1 <- anova(model_1)
anova_1
```

## Hypothesis testing

${H_0}$ : ${\beta_1}$ $=$ ${\beta_2}$ ${=}$ ${\beta_3}$ $=$  0

${H_a}$ : ${\beta_i}$ $\ne$ 0 for atleast one $i$, where $i$ = 1,2..`r nr`


```{r 1_c_2}
SSR <- anova_1$`Sum Sq`
SSE <- SSR[p]
SSR <- SSR[1:nr]
DF <- anova_1$Df
F0 <- (sum(SSR)/sum(DF[1:nr])) / (SSE/DF[p])
F_CRIT <- qf(df1 = sum(DF[1:nr]), df2 = DF[p], p = 0.95)
```

Since **${F_0}$ : `r F0` `r ifelse(F0 > F_CRIT, '>', '<')` ${F_{3,15,.95}}$ : `r F_CRIT`**, We **`r ifelse(F0 > F_CRIT, 'reject', 'fail to reject')`** the null hypothesis that at ${\alpha}$ = 0.5, and can conclude that **`r ifelse(F0 > F_CRIT, 'at least one of', 'all of')` ${\beta}_s$ are `r ifelse(F0 > F_CRIT, 'not equal', 'equal')` to 0**.

### Tests on individual regression coefficients

${H_0}$ : ${\beta_i}$ $=$ 0

${H_a}$ : ${\beta_i}$ $\ne$ 0, where $i$ = 1,2..`r nr`

```{r 1_c_3}
t_stats_1 <- abs((coefs[2] - 0)/sigma * sqrt(C[2,2]))
t_stats_2 <- abs((coefs[3] - 0)/sigma * sqrt(C[3,3]))
t_stats_3 <- abs((coefs[4] - 0)/sigma * sqrt(C[4,4]))
T_CRIT <- qt(p = 0.975, df = n - nr - 1)
```

For $\beta_1$

Since **${t_0}$ : `r t_stats_1` `r ifelse(t_stats_1 > T_CRIT, '>', '<')` ${t_{15,.975}}$ : `r T_CRIT`**, We **`r ifelse(t_stats_1 > T_CRIT, 'reject', 'fail to reject')`** the null hypothesis.

For $\beta_2$

Since **${t_0}$ : `r t_stats_2` `r ifelse(t_stats_2 > T_CRIT, '>', '<')` ${t_{15,.975}}$ : `r T_CRIT`**, We **`r ifelse(t_stats_2 > T_CRIT, 'reject', 'fail to reject')`** the null hypothesis.

For $\beta_3$

Since **${t_0}$ : `r t_stats_3` `r ifelse(t_stats_3 > T_CRIT, '>', '<')` ${t_{15,.975}}$ : `r T_CRIT`**, We **`r ifelse(t_stats_3 > T_CRIT, 'reject', 'fail to reject')`** the null hypothesis.

```{r 1_d}
cor(df, method = c("pearson"))
```

```{r}
corrplot::corrplot(cor(df, method = c("pearson")), type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```


```{r}
car::vif(model_1)
sqrt(car::vif(model_1)) > 2 #Problem ?
```

```{r residual_plot_1}
plot(e, pch=16, col="blue")
```

```{r}
hist(e,probability=T, main="Histogram of residuals",xlab="Residuals")
lines(density(e),col=2)
```

```{r}
standard_residual <- rstandard(model_1)
hist(standard_residual, freq=FALSE,
main="Distribution of Standardized Residuals")
xp<-seq(min(standard_residual),max(standard_residual),length=n)
yp<-dnorm(xp)
lines(xp, yp)
```

```{r}
qqnorm(e,main="QQ plot of residuals",pch=16, col = "blue")
qqline(e)
qq <- qqPlot(model_1,simulate = T, main = "Q-Q Plot")
```

```{r 1_e_4}
durbinWatsonTest(model_1)
```

```{r 1_e_5}
shapiro.test(e)
```

```{r 1_e_6}
ncvTest(model_1)
```

```{r 1_e_7}
acf(e)
```

```{r}
plot(model_1, which=4, cook.levels= 4/((n-length(model_1$coefficients)-2)))
```

```{r }
inplot <- influencePlot(model_1, main="Influence Plot", sub="Circle size is proportial to Cook's Distance" )
```
```{r}
hat.plot(model_1)
```


```{r}
hatval <- hatvalues(model_1)
hatval[hatval > 0.2]
```


```{r}
crPlots(model_1)
```
```{r}
spreadLevelPlot(model_1)
```
```{r}
car::outlierTest(model_1)
```

```{r}
avPlots(model_1, 
        ask = F)
```


```{r 1_e}
leaps<- regsubsets(Y~BdyWt+LvrWt+Dose,data=df,nbest=10,method=c("backward"), nvmax = 10) # method=c("exhaustive", "backward", "forward", "seqrep")
# view results 
summary(leaps)
```
```{r 1_e_1}
# plot a table of models showing variables in each model.
# models are ordered by the selection statistic.
plot(leaps,scale="r2")
```
```{r}
cs <- car::subsets(leaps, legend=FALSE, statistic=c("bic", "cp", "adjr2", "rsq", "rss"))
cs
```

```{r 1_e_2}
step <- stepAIC(model_1, direction="backward")
summary(step)
```
```{r 1_e_3}
step$anova
```

```{r 2_data}
df2 <- data.frame(numeric(), numeric(), numeric(), numeric())
df2 <- rbind(df2, c(105000,16300,1.25,547.9))
df2 <- rbind(df2, c(105000,15800,1.34,593.4))
df2 <- rbind(df2, c(121600,16000,1.22,638.9))
df2 <- rbind(df2, c(113750,14200,1.00,695.3))
df2 <- rbind(df2, c(113750,15000,1.15,751.8))
df2 <- rbind(df2, c(128925,14000,1.13,810.3))
df2 <- rbind(df2, c(142500,15400,1.05,914.5))
df2 <- rbind(df2, c(126000,18250,1.27,998.3))
df2 <- rbind(df2, c(162000,17300,1.07,1096.1))
df2 <- rbind(df2, c(191625,23000,1.17,1194.4))
df2 <- rbind(df2, c(189000,19300,1.07,1311.5))
df2 <- rbind(df2, c(210000,23056,1.54,1462.9))
df2 <- rbind(df2, c(224250,26000,1.59,1641.7))
df2 <- rbind(df2, c(245000,28000,1.56,1821.7))
colnames(df2) <- c("crest_sales", "crest_budget", "ratio", "disposable_income")
```

```{r}
pairs(df2[,1:4])
car::scatterplotMatrix(df2, #data to be plotted
                 main = "Scatter Plot Matrix")
```

```{r 2_a_1}
model_2 <- lm(crest_sales~crest_budget+ratio+disposable_income, data = df2)
summary(model_2)
```


```{r model_2_diagonistic}
par(mfrow=c(2,2))
plot(model_2)
```



```{r 2annova}
anova_2 <- anova(model_2)
anova_2
```

```{r}
cor(df2, method = c("pearson"))
```
```{r}
corrplot::corrplot(cor(df2, method = c("pearson")), type = "upper", order = "hclust", 
         tl.col = "black", tl.srt = 45)
```

```{r}
car::vif(model_2)
sqrt(car::vif(model_2)) > 2
```
```{r}
n2 <- nrow(df2)
nr2 <- ncol(df2) - 1
p2 <- length(coef(model_2))
X_2 <- as.matrix(cbind(rep(1, n2), df2$crest_budget, df2$ratio, df2$disposable_income))
y_2 <- df2$crest_sales
# t(X) %*% X ## matrix multiplication in R
C_2 <- solve(t(X_2) %*% X_2) ## solve is used for inverse of matrix, t(X) %*% X is matrix multiplication in R
C_2
```

```{r 2_b}
beta_hat2 <- solve(t(X_2) %*% X_2) %*% t(X_2) %*% y_2
coefs2 <- as.vector(beta_hat2[,1])
y_hat2 <- X_2 %*% solve(t(X_2) %*% X_2) %*% t(X_2) %*% y_2
e2 <- y_2 - y_hat2
sigma2 <- sqrt(t(e2) %*% e2 / (n2 - p2))
summary(model_2)$sigma
```

```{r residual_plot_2}
plot(e2, pch=16, col="blue")
```

```{r}
hist(e2,probability=T, main="Histogram of residuals",xlab="Residuals")
lines(density(e2),col=2)
```

```{r}
standard_residual <- rstandard(model_2)
hist(standard_residual, freq=FALSE,
main="Distribution of Standardized Residuals")
xp<-seq(min(standard_residual),max(standard_residual),length=n2)
yp<-dnorm(xp)
lines(xp, yp)
```

```{r}
qqnorm(e2,main="QQ plot of residuals",pch=16, col = "blue")
qqline(e2)
qq <- qqPlot(model_2,simulate = T, main = "Q-Q Plot")
```

```{r 2_e_4}
durbinWatsonTest(model_2)
```

```{r 2_e_5}
shapiro.test(e2)
```

```{r 2_e_6}
ncvTest(model_2)
```

```{r 2_e_7}
acf(e2)
```

```{r}
plot(model_2, which=4, cook.levels= 4/((n2-length(model_2$coefficients)-2)))
```

```{r }
inplot <- influencePlot(model_2, main="Influence Plot", sub="Circle size is proportial to Cook's Distance" )
```

```{r}
hat.plot(model_2)
```


```{r}
hatval <- hatvalues(model_2)
hatval[hatval > 0.2]
```

```{r}
crPlots(model_2)
```
```{r}
spreadLevelPlot(model_2)
```

```{r}
car::outlierTest(model_2)
```
```{r}
avPlots(model_2, 
        ask = F)
```

```{r 2_e}
leaps_2 <- regsubsets(crest_sales~crest_budget+ratio+disposable_income,data=df2,nbest=10,method=c("exhaustive", "backward", "forward", "seqrep"), nvmax = 10)
# view results 
summary(leaps_2)
```
```{r 2_e_1}
# plot a table of models showing variables in each model.
# models are ordered by the selection statistic.
plot(leaps_2,scale="r2")
```

```{r}
cs2 <- car::subsets(leaps_2, legend=FALSE, statistic=c("bic", "cp", "adjr2", "rsq", "rss"))
cs2
```



```{r 2_e_2}
step_2 <- stepAIC(model_2, direction="both")
summary(step_2)
```
```{r 2_e_3}
step_2$anova
```


* https://dataplatform.cloud.ibm.com/analytics/notebooks/e787a636-1c72-4e98-9094-84bad58bfa75/view?access_token=5e68f5b0b92a9471d4607cc719d9a36fe46509dfc891f5ad4b1777cf50dff86d
- https://www.statmethods.net/stats/regression.html
- http://www.sthda.com/english/articles/37-model-selection-essentials-in-r/154-stepwise-regression-essentials-in-r/
- https://courses.washington.edu/b515/l5.pdf
- https://www.calvin.edu/~rpruim/courses/s341/S17/from-class/MathinRmd.html
- http://www.ams.sunysb.edu/~zhu/ams571/Regression.pdf
- https://daviddalpiaz.github.io/appliedstats/multiple-linear-regression.html


